WITH ranked_properties AS ( SELECT JSONExtractString(e.properties, 'accusantium') AS accusantium, CAST(COUNT(DISTINCT e.uuid) AS INT) AS total_count, DENSE_RANK() OVER (ORDER BY COUNT() DESC, accusantium ASC) AS rank, IF (rank <= 10, accusantium, 'Other') AS accusantium_or_other FROM events AS e WHERE swishjam_api_key IN ('public--swishjam_prdct-31002150c52026ec', 'public--swishjam_web-b106b6df43b8fec8', 'swishjam_stripe-4b539ce2c55be090', 'swishjam_resend-bf4c8c70bf046101', 'swishjam_interc-4494216641e2e6ec') AND occurred_at BETWEEN '2024-04-22 00:00:00' AND '2024-04-29 18:59:59' AND name = 'Chat Closed' AND (1=1 ) GROUP BY accusantium ) 
SELECT IF(empty(rr.accusantium_or_other), 'EMPTY', rr.accusantium_or_other}) AS accusantium, DATE_TRUNC('hour', e.occurred_at) AS group_by_date, CAST(COUNT(DISTINCT e.uuid) AS INT) AS count FROM events AS e JOIN ranked_properties AS rr ON JSONExtractString(e.properties, 'accusantium') = rr.accusantium WHERE e.swishjam_api_key IN ('public--swishjam_prdct-31002150c52026ec', 'public--swishjam_web-b106b6df43b8fec8', 'swishjam_stripe-4b539ce2c55be090', 'swishjam_resend-bf4c8c70bf046101', 'swishjam_interc-4494216641e2e6ec') AND e.occurred_at BETWEEN '2024-04-22 00:00:00' AND '2024-04-29 18:59:59' AND e.name = 'Chat Closed' AND (1=1 ) GROUP BY group_by_date, accusantium ORDER BY group_by_date, count